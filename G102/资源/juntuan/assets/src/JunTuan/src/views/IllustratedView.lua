---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hkc.
--- DateTime: 2021/5/8 15:42
---


-- 怪物图鉴
local IllustratedView = class("IllustratedView", ViewBase)

function IllustratedView:ctor()
    self:enableNodeEvents()
    self:initData()
end

function IllustratedView:onEnter()
    self:addEventListener();
    self:initView()
end

function IllustratedView:addEventListener()
    self.monsterBookRewarded = MessageManager.Shared():addMsg(MsgKeyData.onMonsterBookRewarded, function ()
        self:onRewardedHandle();
    end);
    self.monsterBookShow = MessageManager.Shared():addMsg(MsgKeyData.onMonsterBookShow, function()
        self:refreshView();
    end);
end

function IllustratedView:removeEventListener()
    MessageManager.Shared():removeMsg(MsgKeyData.onMonsterBookRewarded,self.monsterBookRewarded);
    MessageManager.Shared():removeMsg(MsgKeyData.onMonsterBookShow, self.monsterBookShow);
end

function IllustratedView:initData()
    -- self.enemyCfg = {
    --     { isShow = 1, skillNum = 1, curLevel = 1 },
    --     { isShow = 1, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    --     { isShow = 0, skillNum = 1, curLevel = 1 },
    -- }
    self.enemyData = UserData.Shared():getMonsterBooks();
    self.detailData = nil;
    self.detailNode = nil;
    self.itemPool = {};
end

function IllustratedView:initView()
    local para = {
        csb = JunTuanCfg.csbCfg.homeView.hand_book,
        setSize = true
    }
    local ui = ViewBase:createCSB(para)
    self.csbNode = ui
    self:addChild(ui)

    local panel_black = ui:getChildByName("Panel_black")
    local panel_main = panel_black:getChildByName("Panel_main")
    self:createAni(panel_main)

    local panel_list = panel_main:getChildByName("Panel_list")
    local panel_1 = panel_list:getChildByName("Panel_1")
    local panel_2 = panel_list:getChildByName("Panel_2"):hide()
    local panel_item = panel_list:getChildByName("Panel_item"):hide()

    local count = 1;
    if self.enemyData == nil then
        return;
    end

    for _,v in pairs(self.enemyData) do
        local item = panel_item:clone()
        item:show()
        local id = v.monsterId;
        item.icon = v.monsterId;
        item.monsterId = v.monsterId;
        self:initItem(item, id, count)
        if count <= 9 then
            panel_1:addChild(item)
            self:setItemPos(item, count)
        else
            panel_2:addChild(item)
            self:setItemPos(item, count - 9)
        end
        self.itemPool[id] = item;
        count  = count + 1;
    end
    local txt_page = panel_main:getChildByName("Text_page_num")
    local btn_close = panel_main:getChildByName("btn_close")
    local btn_page_left = panel_main:getChildByName("btn_page_left")
    local btn_page_right = panel_main:getChildByName("btn_page_right")
    local function btnCall(btn)
        if btn == btn_close then
            self:destroyAni(panel_main, function ()
                self:removeFromParent(true)
            end)
        elseif btn == btn_page_left then
            panel_1:show()
            panel_2:hide()
            txt_page:setString("1/2")
        elseif btn == btn_page_right then
            panel_1:hide()
            panel_2:show()
            txt_page:setString("2/2")
        end
    end
    ExternalTools:addBtnTouchEventListener(btn_close, btnCall)
    ExternalTools:addBtnTouchEventListener(btn_page_left, btnCall)
    ExternalTools:addBtnTouchEventListener(btn_page_right, btnCall)
end

function IllustratedView:refreshView()
    local counter = 1;
    for _,v in pairs(self.itemPool) do
        self:initItem(v, v.monsterId,counter);
        counter  = counter + 1;
    end
end

-- 初始化怪物图鉴item id是由服务器发过来的icon
function IllustratedView:initItem(item, id,index)
    item:setEnabled(true)
    item:setTouchEnabled(true)
    local sub_list = { 30, 20, 10, 20, 0, 0, 25, 15, 18, 10, 10, 10, 20, 25, 25, 5, 0 }
    local txt_name = item:getChildByName("Text_name"):hide()
    local panel_press = item:getChildByName("Panel_press")
    local panel_enemy = item:getChildByName("Panel_enemy")
    local press_bar = panel_press:getChildByName("press_bar")
    local icon_soul = item:getChildByName("icon_soul"):hide()
    local txt_none = item:getChildByName("Text_none"):hide()
    -- local cfg = GameTool:getEnemyIllustrated(id)
    local data = self.enemyData[id];

    -- if cfg == nil then return end

    local ani = nil;
    local icon = id
    local desCfg = GameTool:getEnemyDes(icon)

    local curNum = 0;
    local maxNum = 0;


    if self.itemPool[id] == nil then
        --print("initItem"..icon);
        ani = AnimationMgr:createEnemySpine(icon)
        local s = panel_enemy:getContentSize()
        ani:setPosition(cc.p(s.width / 2, s.height / 2 - (sub_list[index] or 0)))
        panel_enemy:addChild(ani)
    end


    if data.killedNums > 0 then
        txt_name:show()
        txt_none:hide()

        curNum = data.killedNums;
        maxNum = data.taskNums;

        local p = math.min(curNum / maxNum * 100, 100)
        press_bar:setPercent(p)
        txt_name:setString(desCfg.Name)
        icon_soul:setVisible(data.isReward == 1 and data.isFinished == 0)
    else
        if self.itemPool[id] == nil then
            ani:setColor(cc.BLACK)
        end
        press_bar:setPercent(0)
        txt_none:show()
    end

    ExternalTools:addBtnTouchEventListener(item, function ()
        if data.killedNums > 0 then
            self.detailData = {
                id = index,
                rewardId = data.rewardId,
                icon = icon,
                name = desCfg.Name,
                desStr = desCfg.Des,
                curNum = curNum,
                maxNum = maxNum,
                rewardNum = data.killedReward,
                monsterId = data.monsterId,
                isFinished = data.isFinished
            }
            self:showDetailView(self.detailData)
        else
            GameTool:showTxtTip("未收录！")
        end
    end)
end

function IllustratedView:setItemPos(item, i)
    local row = math.ceil(i / 3)
    local col = i % 3
    col = col == 0 and 3 or col
    local x = 111.5 + (col - 1) * 200
    local y = 468 - (row - 1) * 230
    item:setPosition(cc.p(x, y))
end

function IllustratedView:showDetailView(data)
    local isNew = false;
    if self.detailNode == nil then
        local para = {
            csb = JunTuanCfg.csbCfg.homeView.hand_detail,
            setSize = true
        }
        local ui = ViewBase:createCSB(para)
        self:addChild(ui)
        self.detailNode = ui;
        isNew = true;
    end

    self.detailNode:setVisible(true);

    local panel_black = self.detailNode:getChildByName("Panel_black")
    local panel_main = panel_black:getChildByName("Panel_main")
    
    if isNew then
        self:createAni(panel_main)
    end

    local sub_list = { 30, 20, 10, 20, 0, 0, 25, 15, 18, 10, 10, 10, 20, 25, 25, 5, 0 }
    local panel_detail = panel_main:getChildByName("Panel_detail")
    panel_detail:setBackGroundImage("res/JunTuan/img/bg_monster2_handbook_jtdzz.png", 0)
    local panel_enemy = panel_detail:getChildByName("Panel_enemy")
    local s = panel_enemy:getContentSize()
    if isNew then
        local ani = AnimationMgr:createEnemySpine(data.icon)
        ani:setPosition(cc.p(s.width / 2, s.height / 2 - sub_list[data.id]))
        panel_enemy:addChild(ani)
    end
    local txt_name = panel_detail:getChildByName("Text_name")
    local txt_detail = panel_detail:getChildByName("Text_detail")
    txt_name:setString(data.name)
    txt_detail:setString(data.desStr)

    local btn_get = panel_main:getChildByName("btn_receive")
    local txt_reward = btn_get:getChildByName("Text_num")
    local icon_gem = btn_get:getChildByName("icon_soul");
    local panel_press = btn_get:getChildByName("Panel_press")
    local txt_btn_get = btn_get:getChildByName("Text_receive");
    local txt_press = panel_press:getChildByName("Text_num")
    local press_bar = panel_press:getChildByName("press_bar")
    txt_reward:setString(data.rewardNum)
    txt_press:setString(string.format("%d/%d", data.curNum, data.maxNum))
    local p = math.min(data.curNum / data.maxNum * 100, 100)
    press_bar:setPercent(p)

    txt_reward:setVisible(0 == data.isFinished);
    icon_gem:setVisible(0 == data.isFinished);

    local function btnCall(btn)
        if btn == panel_black then
            self:destroyAni(panel_main, function ()
                self.detailNode:removeFromParent(true);
                self.detailNode = nil;
                self:refreshView();
            end)
        elseif btn == btn_get then
            if data.curNum < data.maxNum then
                GameTool:showTxtTip("不满足领取条件")
                return
            end
            -- 发送领取图鉴奖励
            local body = {
                monsterId = btn.monsterId,
                rewardId = btn.rewardId
            }
            if btn.isFinished == 1 then
                GameTool:showTxtTip("已领完");
                return;
            end
            MsgSendMgr:sendMonsterBookGetReward(body);
        end
    end
    local btnStateStr = data.isFinished == 0 and "点击领取" or "已领完";
    txt_btn_get:setString(btnStateStr);
    btn_get.monsterId = data.monsterId;
    btn_get.rewardId = data.rewardId;
    btn_get.isFinished = data.isFinished;
    ExternalTools:addBtnTouchEventListener(panel_black, btnCall, true)
    ExternalTools:addBtnTouchEventListener(btn_get, btnCall)
end

function IllustratedView:onRewardedHandle()
    if self.detailData == nil then return end
    if self.detailData.rewardNum > 0 then
        GameTool:updateGem(self.detailData.rewardNum)
    end
    self.enemyData = UserData.Shared():getMonsterBooks();
    local data = self.enemyData[self.detailData.monsterId];
    self.detailData.curNum = data.killedNums;
    self.detailData.maxNum = data.taskNums;
    self.detailData.rewardNum = data.killedReward;
    self.detailData.rewardId = data.rewardId;
    self.detailData.isFinished = data.isFinished;
    self:refreshView();
    self:showDetailView(self.detailData)
end


function IllustratedView:onExit()
    self:removeEventListener();
end

return IllustratedView