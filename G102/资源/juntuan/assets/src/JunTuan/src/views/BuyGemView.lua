---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hkc.
--- DateTime: 2021/6/2 16:00
---

-- 购买钻石界面
local BuyGemView = class("BuyGemView", ViewBase)

local buyDataCfg = {
    { money = 6, gem = 60, give = 0 },
    { money = 18, gem = 180, give = 10 },
    { money = 30, gem = 300, give = 80 },
    { money = 68, gem = 680, give = 180 },
    { money = 128, gem = 1280, give = 400 },
    { money = 258, gem = 2580, give = 1000 },
}

function BuyGemView:ctor(para)
    self:enableNodeEvents()
    self:initData(para)
end

function BuyGemView:onEnter()
    local pb = {
        userAct = Define.USER_ACTION.recharge_view,
    }
    HttpManager.Shared():sendUserAction(pb)
    self:initView()
    self:addNotify()
end

function BuyGemView:initData(para)
    if para then
        self.parent = para.parent
    end

    local data = UserData.Shared().gameCfg[Define.ENUM_CFG_KEY.SHOP_CFG]
    for i, v in pairs(data) do
        if buyDataCfg[i] then
            buyDataCfg[i].money = v.price
            buyDataCfg[i].gem = v.pnum
            buyDataCfg[i].productid = v.productid
            buyDataCfg[i].productname = v.productname
            buyDataCfg[i].ratio = v.addratio
        end
    end
end

function BuyGemView:initView()
    local para = {
        csb = JunTuanCfg.csbCfg.shopView.shop_buy,
        setSize = true
    }
    local ui = ViewBase:createCSB(para)
    self:addChild(ui)

    local panel_black = ui:getChildByName("Panel_black")
    local panel_main = panel_black:getChildByName("Panel_main")
    local panel_gem = panel_main:getChildByName("Panel_gem")
    self:createAni(panel_main)
    self:initPanelGem(panel_gem)

    local btn_close = panel_main:getChildByName("btn_close")
    ExternalTools:addBtnTouchEventListener(btn_close, function ()
        self:destroyAni(panel_main, function()
            if self.parent and self.parent.buyGemView then
                self.parent.buyGemView = nil
            end
            self:removeFromParent(true)
        end)
    end)
end

function BuyGemView:initBuyItem(item, data, i)
    local txt_num = item:getChildByName("Text_num")
    local txt_give = item:getChildByName("Text_num_1")
    local txt_money = item:getChildByName("Text_money")
    local money = data.money
    local gem = data.gem
    local ratio = data.ratio
    local give = data.gem * ratio
    if give > 0 then
        txt_num:setString(gem)
        txt_give:setString("+" .. give)
        local x = txt_num:getPositionX()
        txt_give:setPositionX(x + 5)
        ExternalTools:txtAutoWidth(txt_give, 85)
    else
        txt_num:setString(gem .. "钻石")
    end
    txt_money:setString(string.format("￥ %d", money))
    ExternalTools:txtAutoWidth(txt_num, 75)
    local function btnCall(btn)
        local data = buyDataCfg[i]
        self:showPayView(data)
    end
    ExternalTools:addBtnTouchEventListener(item, btnCall)
end

function BuyGemView:initPanelGem(panel)
    for i = 1, 6 do
        local data = buyDataCfg[i]
        local item = panel:getChildByName("Panel_" .. i)
        self:initBuyItem(item, data, i)
    end
end

function BuyGemView:showPayView(data)
    local view = require("JunTuan.src.views.PayView").new(data)
    ExternalTools:showView(view, self)
end

function BuyGemView:addNotify()

end

function BuyGemView:removeNotify()

end

function BuyGemView:onExit()
    self:removeNotify()
end

return BuyGemView