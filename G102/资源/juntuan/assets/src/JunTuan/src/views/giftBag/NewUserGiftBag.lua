---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hkc.
--- DateTime: 2021/6/25 9:59
---

-- 新手礼包
local NewUserGiftBag = class("NewUserGiftBag", ViewBase)

function NewUserGiftBag:ctor(para)
    self:enableNodeEvents()
    self:initData(para)
end

function NewUserGiftBag:onEnter()
    local pb = {
        userAct = Define.USER_ACTION.newUser_view,
    }
    HttpManager.Shared():sendUserAction(pb)
    self:initView()
    self:addNotify()
end

function NewUserGiftBag:initData(para)
    if para then
        self.call = para.call
    end
    local productId = GiftBagCfg.productID_Cfg.NewUserBag
    local info = UserData.Shared().gameCfg[Define.ENUM_CFG_KEY.SHOP_CFG][productId]
    local cfgs = UserData.Shared().gameCfg[Define.ENUM_CFG_KEY.RECHARGE_INFO]
    local gems = 0
    for _, v in pairs(cfgs) do
        if v.ProductId == productId and v.RewardType == Define.ENUM_REWARD_TYPE.GEM then
            gems = v.RewardNums
        end
    end
    local data = {
        money = info.price,
        productid = info.productid,
        productname = info.productname,
        gems = gems
    }
    self.data = data
end

function NewUserGiftBag:initView()
    local para = {
        csb = JunTuanCfg.csbCfg.GiftBag.newUser,
        setSize = true
    }
    local ui = ViewBase:createCSB(para)
    self:addChild(ui)

    local panel_black = ui:getChildByName("Panel_black")
    local panel_main = panel_black:getChildByName("Panel_main")
    self:createAni(panel_main)

    local Panel_diamond = panel_main:getChildByName("Panel_diamond")
    local txt_num = Panel_diamond:getChildByName("Text_num")
    txt_num:setString(self.data.gems .. "钻石")
    local btn_buy = panel_main:getChildByName("btn_buy")
    local txt_price = btn_buy:getChildByName("Text_buy")
    txt_price:setString(string.format("%d元购买", self.data.money))
    local btn_close = panel_main:getChildByName("btn_close")
    local function btnCall(btn)
        if btn == btn_close then
            self:destroyAni(panel_main, function()
                if self.call then
                    self.call()
                end
                self:removeFromParent(true)
            end)
        elseif btn == btn_buy then
            self:showPayView()
        end
    end
    ExternalTools:addBtnTouchEventListener(btn_buy, btnCall)
    ExternalTools:addBtnTouchEventListener(btn_close, btnCall)
end

function NewUserGiftBag:showPayView()
    local view = require("JunTuan.src.views.PayView").new(self.data)
    ExternalTools:showView(view, self)
end

function NewUserGiftBag:handleRechargeSuc(data)
    self:removeFromParent()
end

function NewUserGiftBag:addNotify()
    self.onRechargeSuc = MessageManager.Shared():addMsg(MsgKeyData.onRechargeSuc, function (data)
        self:handleRechargeSuc(data)
    end)
end

function NewUserGiftBag:removeNotify()
    MessageManager.Shared():removeMsg(MsgKeyData.onRechargeSuc, self.onRechargeSuc)
end

function NewUserGiftBag:onExit()
    self:removeNotify()
end

return NewUserGiftBag