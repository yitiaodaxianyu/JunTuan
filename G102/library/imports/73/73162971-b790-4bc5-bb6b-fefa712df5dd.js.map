{"version":3,"sources":["assets\\Scripts\\Joystick\\Joystick.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAM,IAAA,KAAwB,EAAE,CAAC,UAAU,EAAnC,OAAO,aAAA,EAAE,QAAQ,cAAkB,CAAC;AAE5C;;GAEG;AACU,QAAA,QAAQ,GAAG,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;AAE7C;;GAEG;AACH,IAAY,aAIX;AAJD,WAAY,aAAa;IACvB,iDAAI,CAAA;IACJ,mDAAK,CAAA;IACL,+CAAG,CAAA;AACL,CAAC,EAJW,aAAa,GAAb,qBAAa,KAAb,qBAAa,QAIxB;AAED;;GAEG;AACH,IAAY,SAIX;AAJD,WAAY,SAAS;IACnB,yCAAI,CAAA;IACJ,6CAAM,CAAA;IACN,yCAAI,CAAA;AACN,CAAC,EAJW,SAAS,GAAT,iBAAS,KAAT,iBAAS,QAIpB;AAED;;GAEG;AACH,IAAY,YAGX;AAHD,WAAY,YAAY;IACtB,iDAAK,CAAA;IACL,mDAAM,CAAA;AACR,CAAC,EAHW,YAAY,GAAZ,oBAAY,KAAZ,oBAAY,QAGvB;AAED;;GAEG;AAEH;IAAsC,4BAAY;IAAlD;QAAA,qEAkLC;QA5KC,SAAG,GAAG,IAAI,CAAC;QAOX,UAAI,GAAG,IAAI,CAAC;QAOZ,kBAAY,GAAG,YAAY,CAAC,MAAM,CAAC;QAOnC,mBAAa,GAAG,aAAa,CAAC,GAAG,CAAC;QAMlC,eAAS,GAAG,IAAI,CAAC;QAMjB,oBAAc,GAAG,IAAI,CAAC;QAKtB,aAAO,GAAG,CAAC,CAAC;;IAsId,CAAC;IApIC,yBAAM,GAAN;QACE,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,GAAG,CAAC,CAAC;QACnC,IAAI,CAAC,eAAe,EAAE,CAAC;QACvB,4BAA4B;QAC5B,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC,MAAM,CAAC;QACxC,IAAI,IAAI,CAAC,YAAY,KAAK,YAAY,CAAC,MAAM,EAAE;YAC7C,IAAI,CAAC,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC;SACvB;IACH,CAAC;IAED;;OAEG;IACH,2BAAQ,GAAR;QACE,gBAAQ,CAAC,EAAE,CAAC,mBAAmB,EAAE,IAAI,CAAC,kBAAkB,EAAE,IAAI,CAAC,CAAC;IAClE,CAAC;IAED;;OAEG;IACH,4BAAS,GAAT;QACE,gBAAQ,CAAC,GAAG,CAAC,mBAAmB,EAAE,IAAI,CAAC,kBAAkB,EAAE,IAAI,CAAC,CAAC;IACnE,CAAC;IAED;;;OAGG;IACH,qCAAkB,GAAlB,UAAmB,IAAkB;QACnC,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,IAAI,CAAC,IAAI,CAAC,OAAO,GAAG,IAAI,KAAK,YAAY,CAAC,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;IAC5D,CAAC;IAED;;OAEG;IACH,kCAAe,GAAf;QACE,iDAAiD;QACjD,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,IAAI,CAAC,gBAAgB,EAAE,IAAI,CAAC,CAAC;QACzE,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,UAAU,EAAE,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,CAAC;QACvE,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;QACrE,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,YAAY,EAAE,IAAI,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;IAC1E,CAAC;IAED;;;OAGG;IACH,mCAAgB,GAAhB,UAAiB,KAA0B;QACzC,gBAAQ,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;QAEpD,IAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,oBAAoB,CAAC,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC;QAErE,IAAI,IAAI,CAAC,YAAY,KAAK,YAAY,CAAC,KAAK,EAAE;YAC5C,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;YAEzC,cAAc;YACd,IAAM,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC;YAE7D,mBAAmB;YACnB,IAAI,CAAC,OAAO,GAAG,QAAQ,IAAI,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;SAC3D;aAAM,IAAI,IAAI,CAAC,YAAY,KAAK,YAAY,CAAC,MAAM,EAAE;YACpD,yBAAyB;YACzB,IAAI,CAAC,SAAS,GAAG,QAAQ,CAAC;YAC1B,IAAI,CAAC,IAAI,CAAC,OAAO,GAAG,GAAG,CAAC;YACxB,IAAI,CAAC,cAAc,GAAG,KAAK,CAAC,WAAW,EAAE,CAAC;YAE1C,UAAU;YACV,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;YAChC,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;SAChC;IACH,CAAC;IAED;;;OAGG;IACH,kCAAe,GAAf,UAAgB,KAA0B;QACxC,wCAAwC;QACxC,IACE,IAAI,CAAC,YAAY,KAAK,YAAY,CAAC,MAAM;YACzC,IAAI,CAAC,cAAc,KAAK,KAAK,CAAC,WAAW,EAAE,EAC3C;YACA,OAAO,KAAK,CAAC;SACd;QAED,eAAe;QACf,IAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,oBAAoB,CAAC,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC;QACrE,IAAM,QAAQ,GAAG,QAAQ,CAAC,GAAG,EAAE,CAAC;QAEhC,kDAAkD;QAClD,IAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,GAAG,QAAQ,CAAC,CAAC,CAAC;QAC3C,IAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,GAAG,QAAQ,CAAC,CAAC,CAAC;QAE3C,MAAM;QACN,IAAM,CAAC,GAAG,EAAE,CAAC,EAAE,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC,SAAS,EAAE,CAAC;QAErE,IAAI,SAAS,CAAC;QAEd,IAAI,IAAI,CAAC,OAAO,GAAG,QAAQ,EAAE;YAC3B,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;YAExC,SAAS,GAAG,SAAS,CAAC,MAAM,CAAC;SAC9B;aAAM;YACL,yBAAyB;YACzB,IAAM,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC;YAChD,IAAM,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC;YAChD,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;YAElC,SAAS,GAAG,SAAS,CAAC,IAAI,CAAC;SAC5B;QAED,gBAAQ,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,UAAU,EAAE,KAAK,EAAE;YACjD,SAAS,EAAE,SAAS;YACpB,YAAY,EAAE,CAAC;SAChB,CAAC,CAAC;IACL,CAAC;IAED;;;OAGG;IACH,iCAAc,GAAd,UAAe,KAA0B;QACvC,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC;QAC9C,IAAI,IAAI,CAAC,YAAY,KAAK,YAAY,CAAC,MAAM,EAAE;YAC7C,IAAI,CAAC,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC;SACvB;QAED,gBAAQ,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,KAAK,EAAE;YAChD,SAAS,EAAE,SAAS,CAAC,IAAI;SAC1B,CAAC,CAAC;IACL,CAAC;IA3KD;QALC,QAAQ,CAAC;YACR,IAAI,EAAE,EAAE,CAAC,IAAI;YACb,WAAW,EAAE,KAAK;YAClB,OAAO,EAAE,OAAO;SACjB,CAAC;yCACS;IAOX;QALC,QAAQ,CAAC;YACR,IAAI,EAAE,EAAE,CAAC,IAAI;YACb,WAAW,EAAE,MAAM;YACnB,OAAO,EAAE,QAAQ;SAClB,CAAC;0CACU;IAOZ;QALC,QAAQ,CAAC;YACR,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,YAAY,CAAC;YAC3B,WAAW,EAAE,YAAY;YACzB,OAAO,EAAE,MAAM;SAChB,CAAC;kDACiC;IAOnC;QALC,QAAQ,CAAC;YACR,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,aAAa,CAAC;YAC5B,WAAW,EAAE,gBAAgB;YAC7B,OAAO,EAAE,MAAM;SAChB,CAAC;mDACgC;IAMlC;QAJC,QAAQ,CAAC;YACR,IAAI,EAAE,EAAE,CAAC,IAAI;YACb,OAAO,EAAE,QAAQ;SAClB,CAAC;+CACe;IAMjB;QAJC,QAAQ,CAAC;YACR,IAAI,EAAE,EAAE,CAAC,IAAI;YACb,OAAO,EAAE,MAAM;SAChB,CAAC;oDACoB;IAKtB;QAHC,QAAQ,CAAC;YACR,OAAO,EAAE,IAAI;SACd,CAAC;6CACU;IA5CO,QAAQ;QAD5B,OAAO;OACa,QAAQ,CAkL5B;IAAD,eAAC;CAlLD,AAkLC,CAlLqC,EAAE,CAAC,SAAS,GAkLjD;kBAlLoB,QAAQ","file":"","sourceRoot":"/","sourcesContent":["const { ccclass, property } = cc._decorator;\n\n/**\n * 全局事件监听实例\n */\nexport const instance = new cc.EventTarget();\n\n/**\n * 方向类型\n */\nexport enum DirectionType {\n  FOUR,\n  EIGHT,\n  ALL,\n}\n\n/**\n * 速度类型\n */\nexport enum SpeedType {\n  STOP,\n  NORMAL,\n  FAST,\n}\n\n/**\n * 摇杆类型\n */\nexport enum JoystickType {\n  FIXED,\n  FOLLOW,\n}\n\n/**\n * 摇杆类\n */\n@ccclass\nexport default class Joystick extends cc.Component {\n  @property({\n    type: cc.Node,\n    displayName: \"Dot\",\n    tooltip: \"摇杆操纵点\",\n  })\n  dot = null;\n\n  @property({\n    type: cc.Node,\n    displayName: \"Ring\",\n    tooltip: \"摇杆背景节点\",\n  })\n  ring = null;\n\n  @property({\n    type: cc.Enum(JoystickType),\n    displayName: \"Touch Type\",\n    tooltip: \"触摸类型\",\n  })\n  joystickType = JoystickType.FOLLOW;\n\n  @property({\n    type: cc.Enum(DirectionType),\n    displayName: \"Direction Type\",\n    tooltip: \"方向类型\",\n  })\n  directionType = DirectionType.ALL;\n\n  @property({\n    type: cc.Node,\n    tooltip: \"摇杆所在位置\",\n  })\n  _stickPos = null;\n\n  @property({\n    type: cc.Node,\n    tooltip: \"触摸位置\",\n  })\n  _touchLocation = null;\n\n  @property({\n    tooltip: \"半径\",\n  })\n  _radius = 0;\n\n  onLoad() {\n    this._radius = this.ring.width / 2;\n    this._initTouchEvent();\n    // hide joystick when follow\n    this.joystickType = JoystickType.FOLLOW;\n    if (this.joystickType === JoystickType.FOLLOW) {\n      this.node.opacity = 0;\n    }\n  }\n\n  /**\n   * 启用时\n   */\n  onEnable() {\n    instance.on(\"set_joystick_type\", this._onSetJoystickType, this);\n  }\n\n  /**\n   * 禁用时\n   */\n  onDisable() {\n    instance.off(\"set_joystick_type\", this._onSetJoystickType, this);\n  }\n\n  /**\n   * 改变摇杆类型\n   * @param type\n   */\n  _onSetJoystickType(type: JoystickType) {\n    this.joystickType = type;\n    this.node.opacity = type === JoystickType.FIXED ? 255 : 0;\n  }\n\n  /**\n   * 初始化触摸事件\n   */\n  _initTouchEvent() {\n    // set the size of joystick node to control scale\n    this.node.on(cc.Node.EventType.TOUCH_START, this._touchStartEvent, this);\n    this.node.on(cc.Node.EventType.TOUCH_MOVE, this._touchMoveEvent, this);\n    this.node.on(cc.Node.EventType.TOUCH_END, this._touchEndEvent, this);\n    this.node.on(cc.Node.EventType.TOUCH_CANCEL, this._touchEndEvent, this);\n  }\n\n  /**\n   * 触摸开始回调函数\n   * @param event\n   */\n  _touchStartEvent(event: cc.Event.EventTouch) {\n    instance.emit(cc.Node.EventType.TOUCH_START, event);\n\n    const touchPos = this.node.convertToNodeSpaceAR(event.getLocation());\n\n    if (this.joystickType === JoystickType.FIXED) {\n      this._stickPos = this.ring.getPosition();\n\n      // 触摸点与圆圈中心的距离\n      const distance = touchPos.sub(this.ring.getPosition()).mag();\n\n      // 手指在圆圈内触摸,控杆跟随触摸点\n      this._radius > distance && this.dot.setPosition(touchPos);\n    } else if (this.joystickType === JoystickType.FOLLOW) {\n      // 记录摇杆位置，给 touch move 使用\n      this._stickPos = touchPos;\n      this.node.opacity = 255;\n      this._touchLocation = event.getLocation();\n\n      // 更改摇杆的位置\n      this.ring.setPosition(touchPos);\n      this.dot.setPosition(touchPos);\n    }\n  }\n\n  /**\n   * 触摸移动回调函数\n   * @param event\n   */\n  _touchMoveEvent(event: cc.Event.EventTouch) {\n    // 如果 touch start 位置和 touch move 相同，禁止移动\n    if (\n      this.joystickType === JoystickType.FOLLOW &&\n      this._touchLocation === event.getLocation()\n    ) {\n      return false;\n    }\n\n    // 以圆圈为锚点获取触摸坐标\n    const touchPos = this.ring.convertToNodeSpaceAR(event.getLocation());\n    const distance = touchPos.mag();\n\n    // 由于摇杆的 postion 是以父节点为锚点，所以定位要加上 touch start 时的位置\n    const posX = this._stickPos.x + touchPos.x;\n    const posY = this._stickPos.y + touchPos.y;\n\n    // 归一化\n    const p = cc.v2(posX, posY).sub(this.ring.getPosition()).normalize();\n\n    let speedType;\n\n    if (this._radius > distance) {\n      this.dot.setPosition(cc.v2(posX, posY));\n\n      speedType = SpeedType.NORMAL;\n    } else {\n      // 控杆永远保持在圈内，并在圈内跟随触摸更新角度\n      const x = this._stickPos.x + p.x * this._radius;\n      const y = this._stickPos.y + p.y * this._radius;\n      this.dot.setPosition(cc.v2(x, y));\n\n      speedType = SpeedType.FAST;\n    }\n\n    instance.emit(cc.Node.EventType.TOUCH_MOVE, event, {\n      speedType: speedType,\n      moveDistance: p,\n    });\n  }\n\n  /**\n   * 触摸结束回调函数\n   * @param event\n   */\n  _touchEndEvent(event: cc.Event.EventTouch) {\n    this.dot.setPosition(this.ring.getPosition());\n    if (this.joystickType === JoystickType.FOLLOW) {\n      this.node.opacity = 0;\n    }\n\n    instance.emit(cc.Node.EventType.TOUCH_END, event, {\n      speedType: SpeedType.STOP,\n    });\n  }\n}\n"]}