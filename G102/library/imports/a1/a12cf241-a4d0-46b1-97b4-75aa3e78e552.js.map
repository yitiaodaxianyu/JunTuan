{"version":3,"sources":["assets\\Scripts\\UserData.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\r\nimport { AccessName, HttpManager } from \"./NetWork/HttpManager\";\r\nimport ApkManager from \"./Ads/ApkManager\";\r\nimport { CurVersionCode, IsDebug } from \"./Constants\";\r\nimport GameManager from \"./GameManager\";\r\nimport { PlayerLevelUpManager } from \"./JsonData/PlayerLevelUp\";\r\nimport { UILayerLevel, UIPath } from \"./UI/UIConfig\";\r\nimport { UIManager } from \"./UI/UIManager\";\r\nimport WXManagerEX from \"../startscene/WXManagerEX\";\r\n\r\nexport default class UserData {\r\n\r\n    private static _instance: UserData = null;\r\n    /**用户的服务器数据是否加载完毕 */\r\n    public is_load_ok:boolean=false;\r\n\r\n    /**版本检测是否完毕 */\r\n    public version_is_ok:boolean=false;\r\n\r\n    //初始化游戏数据    \r\n    init () {\r\n        if(!this.getUserID()){\r\n            this.HttpPostGetUserId(this.randomDeviceId(16),\"Organic\");\r\n        }else{\r\n            this.is_load_ok=true;\r\n        }        \r\n    }\r\n\r\n\r\n    \r\n    public static getInstance():UserData\r\n    {\r\n        if(this._instance==null)\r\n        {\r\n            this._instance=new UserData();\r\n            this._instance.init();\r\n        }\r\n        return this._instance;\r\n    }\r\n\r\n    randomLetter(len:number):string \r\n    {\r\n        const letters = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\";\r\n        let res = ''\r\n        for (let i = 0; i < len; i++) {\r\n            let n = Math.floor(Math.random() * letters.length)\r\n            res += letters[n]\r\n        }\r\n        return res\r\n    }\r\n\r\n    randomDeviceId(len:number):string \r\n    {\r\n        const letters = \"abcdefghijklmnopqrstuvwxyz0123456789\";\r\n        let res = ''\r\n        for (let i = 0; i < len; i++) {\r\n            let n = Math.floor(Math.random() * letters.length)\r\n            res += letters[n]\r\n        }\r\n        return res\r\n    }\r\n\r\n    //添加\r\n    addUserLevel(num:number):boolean\r\n    {\r\n        let newNum=this.getUserLevel()+num;\r\n        if(newNum>=0) {\r\n            this.saveUserLevel(newNum);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    getUserLevel():number{\r\n        let num=cc.sys.localStorage.getItem('user_level');\r\n        if(num===\"\" || num===null)\r\n        {\r\n            num=1;\r\n        }else\r\n        {\r\n            num=parseInt(num);            \r\n        }\r\n        return num;\r\n    }\r\n\r\n    //保存数量\r\n    saveUserLevel(newNum:number)\r\n    {\r\n        cc.sys.localStorage.setItem('user_level', newNum);\r\n    }\r\n\r\n    //更改数量\r\n    changeUserExp(num:number):boolean\r\n    {\r\n        let newNum=this.getUserExp()+num;\r\n        if(newNum>=0) {\r\n            this.saveUserExp(newNum);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    getUserExp():number{\r\n        let num=cc.sys.localStorage.getItem('user_exp');\r\n        if(num===\"\" || num===null)\r\n        {\r\n            num=0;            \r\n        }else\r\n        {\r\n            num=parseInt(num);            \r\n        }\r\n        return num;\r\n    }\r\n\r\n    //保存数量\r\n    saveUserExp(newNum:number)\r\n    {\r\n        cc.sys.localStorage.setItem('user_exp', newNum);\r\n        let level=this.getUserLevel();\r\n        let maxLevel=PlayerLevelUpManager.getMaxPlayerLevel();\r\n        GameManager.getInstance().refreshUserExpShow();\r\n        if(level<maxLevel && newNum >= PlayerLevelUpManager.getInstance().getPlayerExpCost(level)){\r\n            //显示玩家升级\r\n            // UIManager.getInstance().showUserLevelUi();\r\n            UIManager.getInstance().showUiDialog(UIPath.UserLevel,UILayerLevel.One,{onCompleted:(uiNode)=> {},});\r\n        }\r\n    }\r\n\r\n    //********************************************账户信息*************************************************   \r\n    getUserName():string\r\n    {\r\n        let str=cc.sys.localStorage.getItem('user_name');\r\n        if(str==='' || str===null)\r\n        {\r\n            str=this.randomLetter(8);\r\n            this.saveUserName(str);\r\n        }\r\n        return str;\r\n    }\r\n\r\n    saveUserName(str:string)\r\n    {\r\n        cc.sys.localStorage.setItem('user_name',str);\r\n    }\r\n\r\n    getUserID():string\r\n    {\r\n        let str=cc.sys.localStorage.getItem('user_id');\r\n        if(str==='' || str===null)\r\n        {\r\n            //请求网络获得uid\r\n            str=\"\";\r\n            this.saveUserID(str);\r\n        }\r\n        // if(cc.sys.isNative==false)\r\n        // {\r\n        //     if(str==='' || str===null){\r\n        //         str=\"Unattributed16520878400a0\";\r\n        //         this.saveUserID(str);\r\n        //     }\r\n        // }\r\n        return str;\r\n    }\r\n\r\n    saveUserID(str:string)\r\n    {\r\n        cc.sys.localStorage.setItem('user_id',str);\r\n    }\r\n\r\n    getVersion():string\r\n    {\r\n        let str=cc.sys.localStorage.getItem('game_version');\r\n        if(str==='' || str===null)\r\n        {\r\n            str='1.2.2'\r\n            //this.saveVersion(str);\r\n        }\r\n        return str;\r\n    }\r\n\r\n    saveVersion(str:string)\r\n    {\r\n        cc.sys.localStorage.setItem('game_version',str);\r\n    }\r\n\r\n    getUserAvatar():number\r\n    {\r\n        let str=cc.sys.localStorage.getItem('user_avatar');\r\n        if(str==='' || str===null)\r\n        {\r\n            str=8;\r\n            this.saveUserAvatar(str);\r\n        }\r\n        str=parseInt(str);\r\n        return str;\r\n    }\r\n\r\n    saveUserAvatar(str:string)\r\n    {\r\n        cc.sys.localStorage.setItem('user_avatar',str);\r\n    }\r\n    \r\n\r\n    /**请求网络生成一个uuid */\r\n    HttpPostGetUserId(deviceId:string,network:string){\r\n        if(this.getUserID()){\r\n            return\r\n        }\r\n        let json={\r\n            uid:\"\",//传空表示获得生成\r\n            network:network,\r\n            user:network,\r\n            appVer:\"\",\r\n            phoneModel:\"HuaWei\",\r\n            pkg:\"com.IdleHeroCastleDefense\",\r\n            sysVer:31,\r\n            lang:\"zh\",\r\n            maxLevel:\"0\",\r\n            totalOnlineDur:\"0\",\r\n            deviceId:deviceId,\r\n            name:\"Test-\"+this.randomLetter(4)\r\n        }\r\n        //this.saveUserID(\"123456789\");\r\n        // this.is_load_ok=true;\r\n        HttpManager.post(AccessName.userBasic,JSON.stringify(json)).then((data:any)=>{\r\n            if(data.uid){\r\n                this.saveUserID(data.uid);\r\n                this.is_load_ok=true;\r\n            }\r\n        }).catch((error)=>{\r\n            cc.error(error);\r\n            //反复请求\r\n            this.HttpPostGetUserId(deviceId,network);\r\n        });\r\n    }\r\n\r\n    /**请求网络检测版本 */\r\n    HttpPostCheckVersion(){\r\n        if(cc.sys.isNative){\r\n            HttpManager.post(AccessName.versionGet,JSON.stringify({})).then((data:any)=>{\r\n                if(data){\r\n                    if(data>CurVersionCode){\r\n                        WXManagerEX.getInstance().resourcesBundle.load(\"loading/version_tip\",cc.Prefab,(error: Error, assets:cc.Prefab)=>{  \r\n                            if(error){\r\n                                cc.log(error);\r\n                                return;\r\n                            }\r\n                            let node=cc.instantiate(assets);\r\n                            node.x=0;\r\n                            node.y=0;\r\n                            cc.find(\"Canvas\").addChild(node);\r\n                        });\r\n                    }else{\r\n                        this.version_is_ok=true;\r\n                    }                \r\n                }else{\r\n                    this.version_is_ok=true;\r\n                }\r\n            }).catch((error)=>{\r\n                cc.error(error);\r\n                this.version_is_ok=true;\r\n            });\r\n        }else\r\n        {\r\n            this.version_is_ok=true;\r\n        }\r\n    }\r\n}\r\n\r\n"]}